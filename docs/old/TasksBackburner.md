- Make tests ensure that all poly functions handle maleformed polys gracefully
- Should I send a pie message everytime i need to end a players turn so we never end up with desynced turn state? rather than f3c23e59c99362c6fc9229cfc19499c3789439a6
- Optional: (M) Interactive terrain (grass spreads fire, water can be frozen to walk on, boulders can be destroyed)
- Potential bug: This may not be a bug once overworld is replaced with Cauldron but currently voteForLevel waits until all clients have voted to move on, however, if a client disconnects without voting, the other clients will be stuck until another client votes
- Potential bug: When player disconnects and reconnects, the game will call initializeTurnPhase and setRoute in order to reestablish the game state.  This MAY cause issues if the game is mid turn. See 1091b4dbb84118dd016bbba75f18a9273f1a656a for explanation.
- (M) wsPie: how to handle reconnection
  1. Reconnection when the server goes down and comes back up (loses room state)
    - This currently puts the game in a buggy state
  2. Reconnection when the client goes down and comes back up (keeps room?)
    - How to handle user joining mid stage (say during overworld or during underworld)?
- Restore replay
- What should happen when you clone yourself?
    - Right now the clone just attacks, but what if your soul could occupy the clone when you die?
- Stresstest gamestate sync:
    - If you delay messages on the backend are you sure they'll arrive in the right order?
- What if it was in a dungeon instead of outside so there could be rooms?
- Things to sync
    - Add syncing for units
        - when: At start of unit turn
        - position, health, mana, spell effects?
        - Send message at start of units turn which asserts RNG state and unit state; then all simulations calculate together
    - Underworld
        - when: ?
        - Exludes Players, Units
        - Syncing RNG
        - turn state
        - pickups
    - Players
        - when: at start of player turn
        - this will also sync upgrades
- Add tests / refactor into module for syncronous message processing to account for:
    - messages arriving out of order
- When a user disconnects on overworld it doesn't check if everyone has voted (this may not be a problem once
i switch to the cauldron overworld)
- Like how dying at start of turn didn't end turn until 24be49dfb4904bc81e683c903ffe0bdcdfc75065, maybe other death causing events wont end turn.  Maybe I should add a check in the unit code when they take damage to always see if it's a player
- repelCircleFromLine doesn't handle corner cases such as vertical lines due to it using intersection of lines under the hood.  Improve intersectionOfLines cornercases.  I protect against this case by doing special handling of vertical lines in findWherePointIntersectLineSegmentAtRightAngle() which calls findWherePointIntersectLineAtRightAngle is the only place that uses intersectionOfLines
- if the host disconnects in character selection mode, the other players get stuck and can't choose characters
- If second client picks character first there is  a bug
- Update server to send message number so clients can know when they both have the latest message.  This'll prevent false positive desync detection
- (MAYBE ALREADY SOLVED)Address possible desync issues around projectile promise? same as with loading a game mid-movement
    - shouldn't this not be an issue though if loading a game happens synchronously? 
    - maybe it should happen synchronously for the sender and then it wont be a problem
    - Also: desync often happens with moveTarget since moveTarget can be set mid way through executing a gamestate_hash check which would make the hashes not equal
- (VERY OPTIONAL) Some kind of visible error mechanism to show when cards don't apply
    - Don't let players cast fizzle spells (AOE or chain without damage)
    - Like if you cast "Protection" on yourself and then AOE it does nothing because there are no targets to AOE off of
    - Or if you cast cards out of order like Dicard without a card after it
- Swap still seems to be broken with chain
- Fixed i think: 
    - Bug: Stuck on AI turn after archers killed resurrected golem
- Maybe I want this?? Bug: Chain targets dead units
- Every unit should always be trying to get in position to do damage
- Swap should only swap with targets, it shouldn't allow arbitrary teleportation
- Balance mana
  - To make this challenging, players should often be on the verge of no mana, it should feel scarce so they have to pick carefully what spells they want to use.
    - Maybe the answer to this is to make spells more expensive every time you use them
      - Branch `log2mana`
      - use log2 so it doesn't get absurdly more expensive
- Brad pickuped cards and kept playing and was later suprised at his new cards. Make it obvious
- I wish i could bring goons with me through the portal
- Chaining too many units crashed the game (optimize chain)
- Attack animation for cloned players is the same as the golem attack animation which is confusing visually
- (maybe) Chain needs a radius to show how far away chaining will occur, maybe
- Clone caused guys to spawn out of bounds
- Check security message when running docker build
- bug: had a message come through where the fromPlayer wasn't set
```
 Handle ONDATA 10 CHOOSE_UPGRADE 
Object { type: 8, upgrade: {…} }
​
type: 8
​
upgrade: Object { title: "Expanding", type: "card", thumbnail: "images/spell/spellIconExpanding.png", … }
​
<prototype>: Object { … }
networkHandler.ts:136:12
09:00:50.844
Cannot choose upgrade, either the caster or upgrade does not exist undefined 
Object { title: "Expanding", type: "card", description: description(), thumbnail: "images/spell/spellIconExpanding.png", maxCopies: 1, effect: effect(player), probability: 10, cost: {…} }
```
- Juice: it'd be cool if mage would stay in the last frame of the akira pose until the akira cast is done
- network problem, if the server starts while a browser is trying to connect to it, it will never connect even after refresh
- Brad marketing recommendations
  - Try adding 'Key Features' bullet points to store description like Into the Breach
  - Move the bottom coolest gif to the top
- Don't play turn end sound fx if you've already ended yoru turn
- should I clear the underworld seed on cleanup?
- sound from offscreen should be played quieter
- don't allow `save` in console to work in viewmenu because it will overwrite the previous save with a not fully initialized underworld
- there is a circumstance in multiplayer where a player's upgradeslefttochoose is 3 but they don't see the popup (happens in local)
- I think the server can get stuck in a state where it's started but doesn't accept connections, hard to reproduce.
  - maybe if a client is already trying to connect when it starts up?
- [unable to reproduce] swap then damage hurts yourself also, it shouldn't be this way it should hurt the target
- [fixed??] wsPie: When reconnects occur it adds a bunch of 'clientId' strings to the end of the url
- [fixed??] wsPie: There seems to be a way in which pie connects successfully but onConnectInfo is never called and so it never resolves
- Autodeploy to app platform digital ocean: https://docs.digitalocean.com/products/app-platform/how-to/deploy-from-monorepo/
- Camera shouldn't jerk around when you die
- "Potential Cast Range" text doesn't scale when you zoom
- bug: if you save while having picked 1 of the 3 starting spells, it loads and shows the picker before the player is synced, so just the text is out of date
- Optimize: game slows down when there's a lot of blood on the screen and it's painint more
- Optimize: Save files need not save unitsPrediction
- player unit has a subsprite without an imagePath, what is it? it's saving as 'null' and then throwing an error when it tries to load it
- Bug: Portal spawns when you prediction kill yourself on test level
- res particles
- liquid issues:
  - liquid messed up; seed: 0.6404564349842206
  - see cantwalk.png on desktop
- trap prediction bugs
- trap should be immovable?
- freeze should shield damage?
    - if frozen unit takes damage it restarts animation
- Brad feedback 2022-08-04
  - targeting mishap, see video
  - clones exploding without bloat modifier, it's like they kept the event somehow
  - upgrade where you gives omethng up to gain something
  - 10th toolbar space isn't filling up when you get a new spell?
  - bug: explosion radius text and some move lines left on the screen after cast was done
- animated trim path line for archers so it's obvious they'll hit you
- Write down Brad's feedback here
    - it should be clear that it rolls spells after you pick
    - Trap pickup radius is too big, you can't squeeze by it (spikes and trap?)
    - should take damage at the END of every turn if still in lava
    - Super poor performance on brad's laptop on level 7
        - double pull through lava make my computer's fan pickup
    - bug: resurrect leaves dangling Images behind
- Pack 16 | Colin Feedback
    - explain that you can cast any number of times per turn
    - Make spell pickups more obvious
    - vampire had attack icon while in lava but next turn got out of the lava and didn't attack
- what happens if you freeze liquid with a unit in it?
- shield should be visible on health bar (it's just temporary health)
- Handle error in menu when attempting to connect to a bad url
- AI should avoid traps when moving
- death circle can be confusing when moved out of the way of the toolbar (add arrow?)
## UI
- Bug: RMB hold on toolbar moves character.  Be very careful when solving this to ensure you don't make clicks in the invisible part of UI elements no longer work
- Prevent RMB movement when mouse is over toolbar
- Disable RMB movement when upgrade screen is up

## To Explain
  - explain that portal cleanses all buffs and curses
  - Introduce mana cost changing of cards when used
  - that all modifiers are removed after each level
## Standalone server backlog bugs
- targeting issues:
  - archer chose me over decoy that was closer???
  - Bug: decoy died and archer changed targets, make units commit to a target at the beginning of the round, else PLAYER FRUSTRATION
- Ensure standalone server doesn't bother running predictions
    - Unless the predictions determine their attacks from "perfect predictions" branch
- It's running hot for some reason
- Game waits a long time after last player has ended their turn before moving on to enemy turn
- headless server runs loop quickly when it has nothing to do (after i make a change and the clients are connecting in the other os window's space)
- is init_game_state being invoked more than once for player 2
- Fix: Move player so it doesn't use stamina because IT MUST bring them to a synced location if their position somehow get's out of sync
    - Desync: Due to the stamina issue I had one player in a different spot on one screen, then when he cast push and pushed a golem into lava the golem only moved and died on one screen and syncUnits didn't correct it somehow
## Perfect prediction attacks
    - I got bit by a vampire but it didn't accurately warn me he would
        - wrap this in with preventing units from changing targets from their prediction even if the decoy dies (lobber move then throw?)
    - Resurrect icon didn't show in prediction when it was buried in a trap that I pushed someone into (in prediction)
    - Units should NEVER change target from their prediction. A case where this happened is when a decoy died from other units attacking it
    - Golem attack predictions are not perfect. See branch 'perfect-predictions'
    - Known issues:
        - push predicted taht a lobber would fall in lava and die but it didn't
            - that same lobber when resurrected just crawled over lava so it must've been inside but just didn't take the damage
## feedback might be won't do:
    - hoisting might not be desireable, what if you want to push then AOE?
    - Colin Direct Feedback:
        - some enemies chould shoot walls to blow yoru cover
        - add moodiness, make it darker
        - pickup potions
        - fun figuring out mechanics
        - felt like rinse and repeat
        - new to genre
        - QWERTASDFG for hotkeys
        - More exciting if archers had a % chance based on distance
        - physics based env:
            - drop corpse in lave and have it shoot out lava
            - bloat gore schrapnel
                - gore ended up on other characters
                - gore on them from being next to explosion
                - gore on walls, leave a mark
                    - blood trail
        - fog of war
        - what if no agro until you got close so you can't just wait for them all to come to you
        - archer arroes hurt allies as it passes through. % chance. multiple types of archers
- Lochlan feedback
    - ding sound design when "leveling up"
    - purified vampires shouldn't spread bloodcurse
    - bloodcurse show as 18+18/36
- Brad feedback
    - Add a glow on hover to spells in spellbook
    - Ambiance, particles around the map
    - precast animations, when you hover over a corpse with resurrect, white particles should come up from the ground
- Pack 9 | R, J & E feedback
    - No stamina bar after portal
    - Freeze spell should stop timer on pickups (or just increase it by 1)
    - Hover should always show tooltip so you can see even when spell is queued
    - shield should have number on it
    - ideas
        - Have push and pull from the start
        - objects to hide behind (raise earth)
        - More objects to interact with

---
- Particle engine
    - add pixelated filter, see stash
    - OR use a pixelated source image instead of a pixelated filter
    - It's the framerate that makes it jarring
- Standalone Server
    - Add "preparing" animation used to reduce desyncs due to network latency, so that if multiple users are casting spells at the same time, the wizard bending down to "charge" as soon as the current user clicks, masks a delay to make sure it doesn't conflict with other spells.  It'll send the spell over the network as soon as the user clicks but waits to cast it so that there aren't conflicting spells making desyncs on multiple clients.
    - Server should be able to send syncs that will wait to execute until turn changes so it doesn't interrupt animations and mess up the state when it syncs
- how to attach priest spell hit animation to moving ally?
- Finish force movement refactor (see stash)
    - When they stop when they hit walls they need to stop hard, not slid into them
    - They go too far into walls
    - take damage when hitting walls (add blood splatter) 
- bug: AOE is giving me "no target" when I click on ground (hurtx4,aoe,hurt)
    - rather than "no target" maybe it just doesn't use mana and shows a fizzle animation?
    - It's giving "no target" because of the first hurt
- bug: push doesn't go as far as expected if CPU is slowed down
- Don't let RMB movement interrupt cast animation
- Investigate webgl context was lost
- Fix: bad-pathing.mkv in videos folder
    - seed: 0.6450583331398443
- priest is attacking /dealing damage to him but he's not a vamp. how?
- bug: Game didn't go to game over when i died by walking into spikes
  - Implement better game over handling. be careful to not trigger game over too early. for example: A units spell might resurrect itself after dying
- dad assumed vampire bite would deal damage
  - resolved with new wording? ask
- Loch feedback: Show all the places you could move by sample size. and shade in an area
- Controls could show on escape menu instead of always
- TODO: Clean: Remove old onMoveEvents? Not used anymore
- Add "modifier" label to spells that are modifiers like "explode / bloat" and blue outline
- (COULDN"T REPRODUCE) Just shielded unit died when i cast one hurt on him (he  already had one shield that I worked through before)
- (COULDN"T REPRODUCE) Loading screen doesn't appear between levels
- (COULDN"T REPRODUCE) Bug: I only have 6 toolbar slots showing up (empty ones don't show)
    - and when I got bitten by a vampire it didn't add "bite" to a new slot (only to my inventory)
- DON'T PREMATURELY OPTIMIZE.  BACKLOG THIS. Refactor castCards to target unit Ids over the network instead of positions to reduce desync issues. Maybe play all targeting cards and THEN send the CAST message?  But what if they are mixed in? not sure how to handle this.  Maybe the cast message sends the effect of the cast (e.g. poison this guy, push this guy from here to here, set this guy's health to this, etc, rather than the cards).
- Ensure trap pickups work after load, they probably done
- The zoom coordinates off issue between multiplayer sessions when casting
    - hit on one screen, miss on another
    - Related?  Brad cast a spell out of range, but it still triggered on my screen
- verify do subsprites persist after serialization save/load?
- How to show when a unit has the vampire modifier
- Fix host alt-tabbing issue
    - This will be fixed with standalone server
- pointInSameDirection returned true in getParametricRelation for perpendicular lines
- bug: You can spawn on a pickup such as spikes
  - couldn't reproduce
- "maximum shield" shows a bunch of times on hover if casting the spell would give them map
- TODO: Split up runPredictions so that it only checks canAttackTarget after units have moved, not every loop
    - Sync prediction units every loop is a waste too if nothing changes
        - This could be optimized so it only recalcs if a unit moves or if the cast target or cast cards change
- When players rejoin in progress game, skip character pick screen
- Maybe solved already? Pathing, see stash "pathfinding"
    - this.seed = '0.9408533248276452';
    - Somehow duplicate points are getting added to path
    - Fix optimize to consider P1 inside angle too
- bug: while messing with forcing desync, player got stuck with red shader on
- I saw deny.png on target when i did in fact have enough mana
- Figure out how to host server locally to be reached via the internet
    - [dedicated server](https://help.steampowered.com/en/faqs/view/6F46-9698-9682-8DB8)
- wspie: https://github.com/websockets/ws#how-to-detect-and-close-broken-connections
- Stress test upping limit for "couldn't find path in enough steps".  If it's not high enough, some units will just not move when they attempt to move to a target that is too complex to path to.
  - Maybe find a way to remove bad paths before the correct one is found?
- **Ask for audio permissions from FF?**
  - May have to trigger it by clicking on a button
- Does pathing information persist after save/load?
- Potential problem where I killed snowpack and left 2 tabs open (and left wsPie open) and my browser was really struggling to load homedepot.com
- Rachels screen was too small and the cards overlapped the grid
- "Mind control" spell, changes their faction temporarily?
- Bug: Loading doesn't work if clientIds have changed reassigning clientIds
- Rachel's Feedback
  - Slay the Spire style chests
  - Two stage levels? Pull a lever to reveal a portal
    - trap doors? Environmental interactions
      - Blow up a square to make it lava
- how to set pixi resolution?
- Heavily test auto reconnect when pie gets disconnected
  - Prevent user input while reconnecting?
  - Will it support reconnecting multiple players if the whole server goes down?
- Could I do without the external port checker and check from the current client via the external ip?
- should unit.die cause player turn to end?
  - or is it fine that this is handled after castCards?
- Should ending turn always go over the network to prevent desyncs?
- A way to change sprite without interrupting animations midway?
  - For example: This occurs when a unit dies while it's attacking
- Rachel request: Support click and drag for queued cards
- Brad request: Allow keybind customization
- What about a prisoner AI that you can unleash, or traps that you can unlease in a line
- enemies should not be able to be on the portal
- **Convert console.error(s) to Sentry.captureException?? before deployment**
- let our faction of AI go before enemy units go
- Swapping should only work with a target, not an empty spell
- quality of life: If you click on the portal and no enemies remain, then auto move there
- Refactor, card UI reconciliation algorithm is slow
- Swap can have unexpected effects if the aoe swap targets overlap with the caster original location, units may end up in an unexpected position, need batching to solve this
- How do players know what their upgrades are
- why do we keep accidentally ending our turns (force of habit with spacebar being used in auto chess?)
- You get "cannot move more than once per turn" while spell animations are firing
- Celebratory damage counter for huge combos!
- Event manager for granting dark card when you slay ally
- Bug: Verified, when I alt tab it desyncs
- Fix sometimes Game.playerTurnIndex is out of sync
  - Maybe this happened because I was alt-tabbed when he took his turn
- Fix replay?
  - This should be easy now that onDataQueue has been restored
- Taunt totem
- Tile effects
  - Lava
  - Tree
  - Burn
  - Poison
- Add "Dark" cards for killing an ally
  - Sacrifice
    - Lose 3 cards at random for health
  - Obliterate
    - Sends everything in range into the void (has a special effect on portals - secret level)
  - Corrupt
- OMA asked for cooperative AI to play with
